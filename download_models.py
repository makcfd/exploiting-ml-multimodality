import argparse
import os

import pandas as pd

import wandb
from my_utilities.config_reader import read_config


BASE_PATH_TO_SAVE = "/exploiting_model_multiplicity/models"


def _download_models(api, project: str, multimodel: list) -> str:
    """
    Downloads models into the defined directory.
    Inputs:
        - multimodel: dictionary where keys are names of artifacts
        - path_to_save: directory where models will be saved
    Outputs:
        - path where downloaded models are saved

    """

    path_to_save = os.path.join(BASE_PATH_TO_SAVE, project)
    if not os.path.exists(path_to_save):
        os.makedirs(path_to_save)
    count = 0
    for model_name in multimodel:
        try:
            artifact = api.artifact(f"makcfd/{project}/{model_name}")
            artifact.download(root=path_to_save)
            count += 1
        except ValueError:
            print("There is no artifact with such a name :(")

        finally:
            print(f"Downloaded artifacts: {count} , name: {model_name}")
    return path_to_save


def get_filtered_candidates(path_to_filtered_csv: str):
    metadata = pd.read_csv(path_to_filtered_csv)
    return [i + ":v0" for i in metadata["Unnamed: 0"]]


def download_filtered_models():
    key = "620527a80f5b194ce6ba9498879a2ebe65db428d"
    api = wandb.Api(api_key=key)

    parser = argparse.ArgumentParser(
        description="Getting trained modes from the experiment"
    )
    parser.add_argument(
        "--config",
        help="Config/Experiment name",
        type=str,
        default=None,
    )
    args = parser.parse_args()
    config = read_config(args.config)

    project_name = config.get("project")
    path = f"/exploiting_model_multiplicity/models/{project_name}/metadata/{project_name}_filtered.csv"

    candidates = get_filtered_candidates(path)

    _download_models(
        api,
        project=project_name,
        multimodel=candidates,
    )


download_filtered_models()
